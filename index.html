Â¿<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software CDB - Inventario</title>
    
    <!-- Scripts Necesarios -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- LibrerÃ­as de Iconos y Utilidades -->
    <script src="https://unpkg.com/lucide-react"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <!-- Firebase SDK -->
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
            }
        }
    </script>

    <style>
        body { margin: 0; font-family: sans-serif; background-color: #0f172a; }
        #root { min-height: 100vh; display: flex; justify-content: center; align-items: center; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module" data-type="babel">
        import { initializeApp } from "firebase/app";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot } from "firebase/firestore";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "firebase/auth";

        const { useState, useEffect, useRef } = React;
        const { 
            Plus, History, Package, ScanLine, Download, ChevronRight, 
            ArrowLeft, Trash2, Printer, Edit3, X, Search, CheckCircle2, 
            AlertTriangle, Loader2, Layers, FileDown 
        } = LucideReact;

        // ============================================================
        // CONFIGURACIÃ“N DE FIREBASE (AsegÃºrate de poner tus llaves aquÃ­)
        // ============================================================
        const firebaseConfig = {
            apiKey: "",
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'maderera-app-cbd';
        const APP_LOGO_URL = "https://cdn-icons-png.freepik.com/256/11536/11536552.png?semt=ais_white_label";

        const BarcodeDisplay = ({ value, id }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current && window.JsBarcode) {
                    window.JsBarcode(canvasRef.current, value, {
                        format: "CODE128",
                        lineColor: "#000",
                        width: 2,
                        height: 80,
                        displayValue: true,
                        fontSize: 14,
                        margin: 10
                    });
                }
            }, [value]);
            return <canvas ref={canvasRef} id={id} className="max-w-full h-auto mx-auto border rounded-2xl bg-white"></canvas>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('menu'); 
            const [packages, setPackages] = useState([]);
            const [selectedPackage, setSelectedPackage] = useState(null);
            const [loading, setLoading] = useState(false);
            const [msg, setMsg] = useState({ text: '', type: '' });
            const [confirmDelete, setConfirmDelete] = useState(false);
            const [isScannerOpen, setIsScannerOpen] = useState(false);
            const [scanInput, setScanInput] = useState('');

            const [formData, setFormData] = useState({
                materia: 'Tabla', largo: '', ancho: '', espesor: '', cantidad: '', procedencia: '', estado: 'Stock', volumenManual: '', oldId: null
            });

            // Auth
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (err) { console.error(err); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // Firestore
            useEffect(() => {
                if (!user) return;
                const q = collection(db, 'paquetes'); // Simplificado para tu repo
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => doc.data());
                    setPackages(data.sort((a, b) => new Date(b.fechaISO) - new Date(a.fechaISO)));
                }, (error) => console.error("Error Firestore:", error));
                return () => unsubscribe();
            }, [user]);

            const showToast = (text, type) => {
                setMsg({ text, type });
                setTimeout(() => setMsg({ text: '', type: '' }), 3000);
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                setLoading(true);
                const finalId = formData.oldId || Math.floor(10000000 + Math.random() * 90000000).toString();
                let calculatedVolumen = formData.materia === 'Descarte' 
                    ? Number(formData.volumenManual).toFixed(4)
                    : ((Number(formData.largo) * Number(formData.ancho) * Number(formData.espesor) * Number(formData.cantidad)) / 1000000000).toFixed(4);

                const now = new Date();
                const newPackageData = {
                    ...formData,
                    id: finalId,
                    volumen: calculatedVolumen,
                    fecha: now.toLocaleString(),
                    fechaISO: now.toISOString(),
                };

                try {
                    await setDoc(doc(db, 'paquetes', finalId), newPackageData);
                    showToast('âœ… Guardado Correctamente', 'success');
                    setView('history');
                } catch (err) {
                    showToast('âŒ Error al guardar', 'error');
                } finally { setLoading(false); }
            };

            const updateStatus = async (id, newStatus) => {
                try {
                    await updateDoc(doc(db, 'paquetes', id), { estado: newStatus });
                    showToast(`ðŸ“¦ Estado: ${newStatus}`, 'success');
                    setSelectedPackage(prev => ({ ...prev, estado: newStatus }));
                } catch (err) { showToast('âŒ Error', 'error'); }
            };

            const exportToExcel = () => {
                const ws = XLSX.utils.json_to_sheet(packages);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Inventario");
                XLSX.writeFile(wb, `Inventario_CDB.xlsx`);
            };

            const getStatusColor = (status) => {
                switch (status) {
                    case 'Stock': return 'bg-blue-100 text-blue-700';
                    case 'Despacho': return 'bg-orange-100 text-orange-700';
                    case 'Recibido': return 'bg-green-100 text-green-700';
                    default: return 'bg-slate-100 text-slate-700';
                }
            };

            return (
                <div className="w-full max-w-md h-screen bg-white shadow-2xl overflow-hidden flex flex-col relative">
                    {/* Header */}
                    <div className="p-6 flex justify-between items-center bg-slate-50 border-b">
                        <div>
                            <h1 className="text-xl font-black text-slate-800">INVENTARIO CBD</h1>
                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Planta de ProducciÃ³n</p>
                        </div>
                        <img src={APP_LOGO_URL} className="w-10 h-10" />
                    </div>

                    {/* Contenido DinÃ¡mico */}
                    <main className="flex-1 overflow-y-auto p-4 pb-24">
                        {view === 'menu' && (
                            <div className="space-y-6">
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setView('register')} className="bg-amber-900 p-6 rounded-3xl text-white flex flex-col gap-3 shadow-lg">
                                        <Plus /> <span className="font-bold text-xs uppercase">Nuevo Registro</span>
                                    </button>
                                    <button onClick={() => setView('history')} className="bg-slate-800 p-6 rounded-3xl text-white flex flex-col gap-3 shadow-lg">
                                        <History /> <span className="font-bold text-xs uppercase">Stock Real</span>
                                    </button>
                                </div>
                                <div className="bg-slate-50 p-6 rounded-3xl flex justify-between items-center border">
                                    <div className="flex items-center gap-3">
                                        <Layers className="text-amber-600" />
                                        <span className="font-bold text-slate-700 text-xs uppercase">Total Paquetes</span>
                                    </div>
                                    <span className="text-2xl font-black">{packages.length}</span>
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-3">
                                <div className="flex justify-between items-center mb-4">
                                    <button onClick={() => setView('menu')} className="p-2 bg-slate-100 rounded-full"><ArrowLeft /></button>
                                    <button onClick={exportToExcel} className="bg-green-600 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase">Excel</button>
                                </div>
                                {packages.map(p => (
                                    <div key={p.id} onClick={() => setSelectedPackage(p)} className="p-4 border rounded-2xl flex justify-between items-center hover:bg-slate-50">
                                        <div>
                                            <p className="font-bold text-slate-800 uppercase">{p.materia}</p>
                                            <p className="text-[10px] text-slate-400 font-mono">#{p.id} â€¢ {p.volumen} mÂ³</p>
                                        </div>
                                        <span className={`text-[8px] font-black px-2 py-1 rounded-md ${getStatusColor(p.estado)}`}>{p.estado}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'register' && (
                            <form onSubmit={handleRegister} className="space-y-4">
                                <button onClick={() => setView('menu')} className="p-2 bg-slate-100 rounded-full mb-2"><ArrowLeft /></button>
                                <select value={formData.materia} onChange={e => setFormData({...formData, materia: e.target.value})} className="w-full p-4 bg-slate-50 rounded-2xl border font-bold">
                                    {['Tabla', 'Taco', 'Liston', 'Yugo', 'Descarte'].map(m => <option key={m} value={m}>{m}</option>)}
                                </select>
                                <div className="grid grid-cols-3 gap-2">
                                    <input placeholder="Largo" type="number" className="p-3 border rounded-xl" onChange={e => setFormData({...formData, largo: e.target.value})} />
                                    <input placeholder="Ancho" type="number" className="p-3 border rounded-xl" onChange={e => setFormData({...formData, ancho: e.target.value})} />
                                    <input placeholder="Espes" type="number" className="p-3 border rounded-xl" onChange={e => setFormData({...formData, espesor: e.target.value})} />
                                </div>
                                <input placeholder="Cantidad" type="number" className="w-full p-4 border rounded-2xl" onChange={e => setFormData({...formData, cantidad: e.target.value})} />
                                <input placeholder="Lote / Origen" type="text" className="w-full p-4 border rounded-2xl" onChange={e => setFormData({...formData, procedencia: e.target.value})} />
                                <button type="submit" className="w-full bg-amber-900 text-white font-black py-4 rounded-2xl">
                                    {loading ? 'Guardando...' : 'REGISTRAR PAQUETE'}
                                </button>
                            </form>
                        )}
                    </main>

                    {/* Nav Barra Inferior */}
                    <nav className="absolute bottom-0 left-0 right-0 h-20 bg-white border-t flex justify-around items-center px-4">
                        <button onClick={() => setView('menu')} className="text-slate-400 hover:text-amber-900 flex flex-col items-center"><Package size={20} /><span className="text-[8px] font-bold">INICIO</span></button>
                        <button onClick={() => setView('history')} className="text-slate-400 hover:text-amber-900 flex flex-col items-center"><History size={20} /><span className="text-[8px] font-bold">STOCK</span></button>
                        <button onClick={() => setView('register')} className="bg-amber-900 text-white p-3 rounded-full -mt-8 border-4 border-white"><Plus size={24} /></button>
                        <button className="text-slate-400 flex flex-col items-center"><ScanLine size={20} /><span className="text-[8px] font-bold">SCAN</span></button>
                        <button onClick={exportToExcel} className="text-slate-400 flex flex-col items-center"><Download size={20} /><span className="text-[8px] font-bold">REPORTE</span></button>
                    </nav>

                    {/* Modal Detalle */}
                    {selectedPackage && (
                        <div className="fixed inset-0 bg-black/50 flex items-end z-50">
                            <div className="bg-white w-full max-w-md rounded-t-[2rem] p-8 space-y-4 animate-in slide-in-from-bottom">
                                <div className="flex justify-between items-center">
                                    <h2 className="text-2xl font-black uppercase">{selectedPackage.materia}</h2>
                                    <button onClick={() => setSelectedPackage(null)}><X /></button>
                                </div>
                                <BarcodeDisplay value={selectedPackage.id} id="bcode" />
                                <div className="grid grid-cols-2 gap-2">
                                    <div className="p-4 bg-slate-50 rounded-2xl text-center">
                                        <p className="text-[8px] font-bold text-slate-400">VOLUMEN</p>
                                        <p className="font-black">{selectedPackage.volumen} mÂ³</p>
                                    </div>
                                    <div className="p-4 bg-slate-50 rounded-2xl text-center">
                                        <p className="text-[8px] font-bold text-slate-400">CANTIDAD</p>
                                        <p className="font-black">{selectedPackage.cantidad} Pzs</p>
                                    </div>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                    {['Stock', 'Despacho', 'Recibido'].map(s => (
                                        <button key={s} onClick={() => updateStatus(selectedPackage.id, s)} className="p-2 border rounded-xl text-[8px] font-bold uppercase">
                                            {s}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
