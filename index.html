<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDB Inventario Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    
    <!-- Firebase App (la base) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Libre+Barcode+39&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .barcode-font { font-family: 'Libre Barcode 39', cursive; font-size: 85px; line-height: 1; }
        @media print {
            body * { visibility: hidden !important; }
            #print-area, #print-area * { visibility: visible !important; }
            #print-area { position: absolute; left: 0; top: 0; width: 100mm; display: block !important; background: white; z-index: 9999; padding: 10px; }
            @page { margin: 0; size: auto; }
        }
        .animate-fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #reader { width: 100%; border-radius: 20px; overflow: hidden; border: none !important; }
    </style>
</head>
<body class="bg-[#F8F9FA]">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, memo } = React;

        // Inicialización de Firebase (Compat Mode para evitar errores de módulos en Babel inline)
        const firebaseConfig = JSON.parse(__firebase_config);
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'cdb-inventario-pro';

        const FormFields = memo(({ data, onChange }) => (
            <div className="space-y-4">
                <div>
                    <label className="text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Tipo de Materia</label>
                    <select name="tipoMateria" value={data.tipoMateria} onChange={onChange} className="w-full bg-slate-50 p-4 rounded-xl font-bold outline-none border border-slate-100">
                        <option value="Tabla">Tabla</option>
                        <option value="Taco">Taco</option>
                        <option value="Liston">Listón</option>
                        <option value="Yugo">Yugo</option>
                        <option value="Descarte">Descarte</option>
                    </select>
                </div>

                {data.tipoMateria !== 'Descarte' ? (
                    <div className="space-y-3 animate-fade-in">
                        <div className="grid grid-cols-2 gap-3">
                            <div className="flex flex-col">
                                <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-1">Largo (mm)</label>
                                <input name="largo" value={data.largo || ''} onChange={onChange} type="number" placeholder="0" className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none focus:border-blue-300"/>
                            </div>
                            <div className="flex flex-col">
                                <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-1">Ancho (mm)</label>
                                <input name="ancho" value={data.ancho || ''} onChange={onChange} type="number" placeholder="0" className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none focus:border-blue-300"/>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div className="flex flex-col">
                                <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-1">Espesor (mm)</label>
                                <input name="espesor" value={data.espesor || ''} onChange={onChange} type="number" placeholder="0" className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none focus:border-blue-300"/>
                            </div>
                            <div className="flex flex-col">
                                <label className="text-[9px] font-bold text-slate-400 uppercase mb-1 ml-1">Piezas</label>
                                <input name="piezas" value={data.piezas || ''} onChange={onChange} type="number" placeholder="0" className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none focus:border-blue-300"/>
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className="space-y-3 animate-fade-in">
                        <label className="text-[10px] font-black text-red-400 uppercase mb-1 ml-1">Metros Cúbicos (m³)</label>
                        <input name="metrosCubicos" value={data.metrosCubicos || ''} onChange={onChange} type="number" step="0.0001" placeholder="0.00" className="w-full bg-red-50 p-6 rounded-xl font-black text-2xl border border-red-100 text-red-900 outline-none"/>
                    </div>
                )}

                <div className="grid grid-cols-2 gap-3">
                    <div className="flex flex-col">
                        <label className="text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Estado</label>
                        <select name="estado" value={data.estado} onChange={onChange} className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none">
                            <option value="Disponible">Disponible</option>
                            <option value="Dañado">Dañado</option>
                            <option value="En Revisión">En Revisión</option>
                        </select>
                    </div>
                    <div className="flex flex-col">
                        <label className="text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Ubicación</label>
                        <select name="flujo" value={data.flujo} onChange={onChange} className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none">
                            <option value="Stock">Stock</option>
                            <option value="Despacho">Despacho</option>
                            <option value="Recibido">Recibido</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label className="text-[10px] font-black text-slate-400 uppercase mb-1 ml-1">Procedencia / Lote</label>
                    <input name="procedencia" value={data.procedencia || ''} onChange={onChange} type="text" placeholder="Ej: Piura, Lote A1" className="w-full bg-slate-50 p-4 rounded-xl font-bold border border-slate-100 outline-none focus:border-blue-300"/>
                </div>
            </div>
        ));

        function App() {
            const [view, setView] = useState('menu');
            const [records, setRecords] = useState([]);
            const [selectedItem, setSelectedItem] = useState(null);
            const [showConfirmDelete, setShowConfirmDelete] = useState(false);
            const [manualCode, setManualCode] = useState('');
            const [isEditing, setIsEditing] = useState(false);
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            
            const initialForm = {
                tipoMateria: 'Tabla',
                largo: '', ancho: '', espesor: '', piezas: '',
                procedencia: '', estado: 'Disponible', flujo: 'Stock', metrosCubicos: ''
            };
            const [formData, setFormData] = useState(initialForm);

            // Manejo de Autenticación
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (error) {
                        console.error("Auth error:", error);
                    }
                };
                initAuth();
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    setUser(u);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Escuchar cambios en Tiempo Real
            useEffect(() => {
                if (!user) return;

                const path = `artifacts/${appId}/public/data/inventario`;
                const unsubscribe = db.collection(path).onSnapshot(
                    (snapshot) => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const sortedItems = items.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
                        setRecords(sortedItems);
                    },
                    (error) => console.error("Firestore Listen error:", error)
                );

                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                let html5QrCode;
                if (view === 'scan') {
                    html5QrCode = new Html5Qrcode("reader");
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            handleSearchCode(decodedText);
                            html5QrCode.stop();
                        },
                        () => { }
                    ).catch(err => console.log("Error cámara:", err));
                }
                return () => {
                    if (html5QrCode && html5QrCode.isScanning) {
                        html5QrCode.stop().catch(e => console.log(e));
                    }
                };
            }, [view]);

            const handleInputChange = useCallback((e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            }, []);

            const saveRecord = async () => {
                if (!user) return;
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                const path = `artifacts/${appId}/public/data/inventario`;
                
                try {
                    if (isEditing) {
                        await db.collection(path).doc(formData.id).update({ 
                            ...formData, 
                            lastEdit: timestamp,
                            updatedBy: user.uid 
                        });
                        setIsEditing(false);
                    } else {
                        const newBarcode = "CDB" + Math.floor(100000 + Math.random() * 900000).toString();
                        await db.collection(path).add({
                            ...formData,
                            barcode: newBarcode,
                            date: timestamp,
                            createdAt: Date.now(),
                            createdBy: user.uid
                        });
                    }
                    setFormData(initialForm);
                    setView('history');
                } catch (e) {
                    console.error("Error saving document: ", e);
                }
            };

            const handleUpdateStatus = async (statusType, value) => {
                if (!user || !selectedItem) return;
                const now = new Date();
                const timestamp = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                const path = `artifacts/${appId}/public/data/inventario`;
                
                try {
                    await db.collection(path).doc(selectedItem.id).update({ 
                        [statusType]: value, 
                        lastEdit: timestamp,
                        updatedBy: user.uid 
                    });
                    setSelectedItem(prev => ({ ...prev, [statusType]: value }));
                } catch (e) {
                    console.error("Error updating status:", e);
                }
            };

            const handleDelete = async () => {
                if (!user || !selectedItem) return;
                const path = `artifacts/${appId}/public/data/inventario`;
                try {
                    await db.collection(path).doc(selectedItem.id).delete();
                    setSelectedItem(null);
                    setShowConfirmDelete(false);
                } catch (e) {
                    console.error("Error deleting document:", e);
                }
            };

            const handleSearchCode = (code) => {
                const found = records.find(r => r.barcode === code.trim());
                if (found) {
                    setSelectedItem(found);
                    setView('menu');
                } else {
                    alert("Código no encontrado: " + code);
                }
            };

            const downloadExcel = () => {
                const now = new Date();
                const timestampStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                const worksheet = XLSX.utils.json_to_sheet(records);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario Realtime");
                XLSX.writeFile(workbook, `CDB_Cloud_Inventario_${timestampStr.replace(/[/:\s]/g, '_')}.xlsx`);
            };

            const calculateTotalM3 = () => {
                return records.reduce((acc, r) => {
                    if (r.tipoMateria === 'Descarte') {
                        return acc + (parseFloat(r.metrosCubicos) || 0);
                    } else {
                        const l = parseFloat(r.largo) || 0;
                        const a = parseFloat(r.ancho) || 0;
                        const e = parseFloat(r.espesor) || 0;
                        const p = parseFloat(r.piezas) || 1;
                        const vol = (l * a * e) / 1000000000;
                        return acc + (vol * p);
                    }
                }, 0).toFixed(4);
            };

            if (loading) return (
                <div className="h-screen flex items-center justify-center bg-[#703818]">
                    <div className="text-white text-center">
                        <div className="animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-4"></div>
                        <p className="font-black uppercase tracking-widest text-xs">Sincronizando Nube...</p>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col bg-slate-50">
                    <header className="bg-[#703818] text-white p-4 flex items-center justify-between shadow-lg sticky top-0 z-50 no-print">
                        <div className="flex items-center gap-3">
                            <div className="bg-white p-1 rounded-lg">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#703818" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                            </div>
                            <div>
                                <h1 className="font-black text-lg uppercase tracking-tighter leading-none">CDB CLOUD</h1>
                                <span className="text-[8px] font-bold text-orange-200 tracking-widest uppercase">Sincronizado</span>
                            </div>
                        </div>
                        <button onClick={downloadExcel} className="bg-white/10 hover:bg-white/20 px-3 py-1 rounded-lg text-[10px] font-bold flex items-center gap-2 uppercase tracking-widest border border-white/20">
                            Excel
                        </button>
                    </header>

                    <main className="flex-1 p-4 pb-24 max-w-2xl mx-auto w-full no-print">
                        {view === 'menu' && (
                            <div className="space-y-4 animate-fade-in">
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => { setIsEditing(false); setFormData(initialForm); setView('register'); }} className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 flex flex-col items-center gap-4 active:scale-95 transition-all">
                                        <div className="text-orange-500 bg-orange-50 p-4 rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
                                        <span className="font-black text-[10px] uppercase text-slate-600 tracking-widest text-center">Nuevo Ingreso</span>
                                    </button>
                                    <button onClick={() => setView('scan')} className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 flex flex-col items-center gap-4 active:scale-95 transition-all">
                                        <div className="text-blue-500 bg-blue-50 p-4 rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg></div>
                                        <span className="font-black text-[10px] uppercase text-slate-600 tracking-widest text-center">Escanear / Buscar</span>
                                    </button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button onClick={() => setView('history')} className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100 flex items-center justify-between px-8 active:scale-95 transition-all w-full">
                                        <div className="flex items-center gap-4">
                                            <div className="text-amber-800 bg-amber-50 p-4 rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></div>
                                            <p className="font-black text-blue-900 leading-none uppercase text-[10px]">Inventario Total</p>
                                        </div>
                                        <span className="text-3xl font-black text-amber-800">{records.length}</span>
                                    </button>
                                    <div className="bg-blue-900 text-white p-6 rounded-[32px] shadow-lg flex items-center justify-between px-8">
                                        <div className="flex items-center gap-4">
                                            <div className="bg-white/10 p-4 rounded-2xl"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg></div>
                                            <p className="font-black text-white leading-none uppercase text-[10px] tracking-widest">Volumen m³</p>
                                        </div>
                                        <span className="text-2xl font-black">{calculateTotalM3()}</span>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'scan' && (
                            <div className="space-y-6 animate-fade-in">
                                <div className="bg-white rounded-[32px] p-2 overflow-hidden shadow-xl border border-slate-100">
                                    <div id="reader"></div>
                                </div>
                                <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100 space-y-4">
                                    <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Entrada Manual</label>
                                    <div className="flex gap-2">
                                        <input type="text" value={manualCode} onChange={(e) => setManualCode(e.target.value)} placeholder="CDBXXXXXX" className="flex-1 bg-slate-50 p-4 rounded-2xl font-bold border border-slate-100 outline-none uppercase"/>
                                        <button onClick={() => handleSearchCode(manualCode)} className="bg-blue-600 text-white p-4 rounded-2xl active:scale-90 transition-all shadow-lg">
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                                        </button>
                                    </div>
                                </div>
                                <button onClick={() => setView('menu')} className="w-full text-slate-400 font-bold uppercase text-[10px] py-4">Volver al Menú</button>
                            </div>
                        )}

                        {view === 'register' && (
                            <div className="bg-white rounded-[32px] p-6 shadow-sm animate-fade-in space-y-4">
                                <h2 className="font-black text-xl text-blue-900 uppercase">{isEditing ? 'Editar Materia' : 'Registrar Materia'}</h2>
                                <FormFields data={formData} onChange={handleInputChange} />
                                <button onClick={saveRecord} className="w-full bg-[#703818] text-white font-black py-5 rounded-2xl uppercase shadow-xl active:scale-95 transition-all mt-6">{isEditing ? 'Guardar Cambios' : 'Confirmar Ingreso'}</button>
                                {isEditing && <button onClick={() => setView('history')} className="w-full text-slate-400 font-bold uppercase text-[10px] py-2">Cancelar Edición</button>}
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="space-y-4 animate-fade-in">
                                <h2 className="font-black text-xl text-blue-900 uppercase px-2">Stock General (Nube)</h2>
                                <div className="space-y-3">
                                    {records.length === 0 ? (
                                        <div className="text-center py-20">
                                            <p className="text-slate-300 font-black uppercase text-xs tracking-widest">Sin Registros en la Nube</p>
                                        </div>
                                    ) : records.map(r => (
                                        <div key={r.id} onClick={() => setSelectedItem(r)} className="bg-white p-5 rounded-[28px] shadow-sm border border-slate-100 flex flex-col gap-3 active:bg-slate-50">
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-3">
                                                    <div className="bg-amber-50 w-10 h-10 rounded-xl flex items-center justify-center font-black text-amber-800 border border-amber-100">{r.tipoMateria ? r.tipoMateria[0] : '?'}</div>
                                                    <div>
                                                        <p className="font-black text-blue-900 uppercase text-sm leading-none">{r.tipoMateria}</p>
                                                        <p className="text-[10px] text-slate-400 font-mono mt-1 tracking-tighter">{r.barcode}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="font-black text-lg text-[#703818]">{r.tipoMateria === 'Descarte' ? `${r.metrosCubicos} m³` : `${r.largo}x${r.ancho}x${r.espesor}`}</p>
                                                    <p className="text-[9px] font-bold text-slate-400 uppercase">{r.piezas ? `${r.piezas} pzs` : 'Cantidad Única'}</p>
                                                </div>
                                            </div>
                                            <div className="pt-2 border-t border-slate-50 grid grid-cols-2 gap-y-1">
                                                <p className="text-[9px] text-slate-400 font-bold uppercase">Estado: <span className="text-blue-600">{r.estado}</span></p>
                                                <p className="text-[9px] text-slate-400 font-bold uppercase text-right">Lote: <span className="text-slate-600">{r.procedencia || '-'}</span></p>
                                                <p className="text-[9px] text-slate-400 font-bold uppercase">Flujo: <span className="text-amber-700">{r.flujo}</span></p>
                                                <p className="text-[9px] text-slate-400 font-bold uppercase text-right">Fecha: <span className="text-slate-600">{r.date || '-'}</span></p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {selectedItem && (
                            <div className="fixed inset-0 z-[60] flex flex-col bg-white animate-fade-in overflow-y-auto no-print">
                                <div className="bg-[#703818] text-white p-5 flex items-center justify-between sticky top-0 shadow-lg">
                                    <span className="font-black uppercase tracking-widest text-[11px]">Control de Item</span>
                                    <button onClick={() => setSelectedItem(null)} className="bg-white/20 p-2 rounded-full active:scale-90 transition-all">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                    </button>
                                </div>

                                <div className="p-8 space-y-8">
                                    <div className="text-center space-y-2">
                                        <h2 className="text-5xl font-black text-blue-900 uppercase tracking-tighter">{selectedItem.tipoMateria}</h2>
                                        <p className="text-lg font-bold text-slate-500 uppercase">LOTE: {selectedItem.procedencia || 'SIN LOTE'}</p>
                                    </div>

                                    <div className="bg-white p-6 rounded-[40px] border-4 border-slate-50 flex flex-col items-center gap-2 shadow-inner">
                                        <div className="barcode-font text-slate-800">*{selectedItem.barcode}*</div>
                                        <p className="font-mono font-black text-2xl tracking-[0.5em] text-slate-800">{selectedItem.barcode}</p>
                                    </div>

                                    <div className="grid grid-cols-1 gap-4">
                                        <div className="bg-slate-50 p-6 rounded-3xl border border-slate-100 flex flex-col gap-2">
                                            <p className="text-[10px] font-black text-slate-400 uppercase">Especificaciones</p>
                                            <p className="font-black text-blue-900 text-xl">
                                                {selectedItem.tipoMateria === 'Descarte' ? `${selectedItem.metrosCubicos} m³` : `${selectedItem.largo}x${selectedItem.ancho}x${selectedItem.espesor} (${selectedItem.piezas} pzs)`}
                                            </p>
                                            <div className="flex gap-2">
                                                <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest">{selectedItem.estado}</span>
                                                <span className="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest">{selectedItem.flujo}</span>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <button onClick={() => handleUpdateStatus('flujo', 'Recibido')} className="bg-purple-600 text-white font-black py-5 rounded-2xl uppercase text-[11px] shadow-lg active:scale-95 transition-all">Recibido</button>
                                            <button onClick={() => handleUpdateStatus('flujo', 'Despacho')} className="bg-blue-600 text-white font-black py-5 rounded-2xl uppercase text-[11px] shadow-lg active:scale-95 transition-all">Despachar</button>
                                        </div>

                                        <button onClick={() => window.print()} className="w-full bg-[#1e293b] text-white font-black py-5 rounded-2xl uppercase text-[11px] active:scale-95 transition-all flex items-center justify-center gap-3 shadow-xl">
                                            Imprimir Etiqueta
                                        </button>

                                        <button onClick={() => { setFormData({...selectedItem}); setIsEditing(true); setView('register'); setSelectedItem(null); }} className="w-full bg-slate-100 text-slate-600 font-black py-5 rounded-2xl uppercase text-[11px] active:scale-95 transition-all">Editar Datos</button>
                                        
                                        <button onClick={() => setShowConfirmDelete(true)} className="w-full text-red-400 font-black text-[9px] uppercase py-4 tracking-widest text-center">Borrar Permanentemente</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {showConfirmDelete && (
                            <div className="fixed inset-0 z-[100] bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-6 no-print">
                                <div className="bg-white rounded-[40px] p-8 w-full max-sm text-center space-y-6 animate-fade-in">
                                    <div className="text-red-500 mx-auto w-16 h-16 bg-red-50 rounded-full flex items-center justify-center"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></div>
                                    <h3 className="font-black text-xl text-slate-900 uppercase">¿Borrar de la Nube?</h3>
                                    <p className="text-slate-400 font-bold text-xs uppercase tracking-tight">Esta acción se reflejará en todos los dispositivos conectados.</p>
                                    <div className="flex flex-col gap-3">
                                        <button onClick={handleDelete} className="bg-red-500 text-white font-black py-4 rounded-2xl uppercase text-xs">Confirmar Borrado</button>
                                        <button onClick={() => setShowConfirmDelete(false)} className="bg-slate-100 text-slate-600 font-black py-4 rounded-2xl uppercase text-xs">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {selectedItem && (
                        <div id="print-area" className="hidden">
                            <div className="border-[4px] border-black p-4 text-center">
                                <h1 className="text-5xl font-black border-b-[6px] border-black pb-4 mb-2 uppercase tracking-tighter">{selectedItem.tipoMateria}</h1>
                                <p className="text-2xl font-black uppercase mb-6 tracking-widest">{selectedItem.procedencia || 'SIN LOTE'}</p>
                                <div className="flex flex-col items-center justify-center">
                                    <div className="barcode-font" style={{fontSize: '140px'}}>*{selectedItem.barcode}*</div>
                                    <div className="text-3xl font-mono font-black mt-2">{selectedItem.barcode}</div>
                                </div>
                                <div className="mt-8 border-t-[4px] border-black pt-4">
                                    <p className="text-xl font-black uppercase tracking-tighter">Sincronizado Cloud: {selectedItem.barcode}</p>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 px-8 py-6 flex justify-between items-center z-40 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] no-print">
                        <button onClick={() => setView('menu')} className={`transition-all ${view === 'menu' ? 'scale-125 text-[#703818]' : 'text-slate-300'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path></svg></button>
                        <button onClick={() => { setIsEditing(false); setFormData(initialForm); setView('register'); }} className={`transition-all ${view === 'register' ? 'scale-125 text-[#703818]' : 'text-slate-300'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg></button>
                        <button onClick={() => setView('history')} className={`transition-all ${view === 'history' ? 'scale-125 text-[#703818]' : 'text-slate-300'}`}><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg></button>
                    </nav>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
